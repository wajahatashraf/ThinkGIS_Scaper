<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zoning Scraper Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  :root {
    --brand: #4257A7;
    --brand-dark: #2e3d7d;
    --accent: #f97316;       /* orange */
    --accent-dark: #ea580c;  /* darker orange */
  }

  body { background: #f7f8fa; font-family: "Inter", sans-serif; min-height: 100vh; margin:0; }
  .navbar { background: var(--brand); }
  .navbar-brand { color: #fff; font-weight: 600; font-size: 1.15rem; }
  .navbar-brand i { margin-right: 8px; }

  .card { border-radius: 12px; box-shadow: 0 6px 25px rgba(0,0,0,0.08); transition: transform 0.2s; background: #fff; position: relative; }
  .card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.12); }
  .card-header { font-weight: 600; font-size: 1.05rem; background: var(--brand); color: white; border-radius: 12px 12px 0 0; padding: 10px 14px; }
  .progress { height: 16px; border-radius: 8px; }
  pre { background: #f4f4f5; color: var(--brand); border-radius: 8px; padding: 10px; height: 180px; overflow-y: auto; font-size: 13px; }

  /* default blue gradient buttons */
  .btn-gradient { background: linear-gradient(90deg, var(--brand), var(--brand-dark)); color: white; font-weight: 500; border: none; }
  .btn-gradient:hover { background: var(--brand-dark); }

  /* new orange accent buttons */
  .btn-orange {
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    color: white;
    font-weight: 500;
    border: none;
  }
  .btn-orange:hover {
    background: var(--accent-dark);
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    text-align: center;
    color: #6b7280;
    padding: 20px;
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 12px;
    color: #9ca3af;
    opacity: 0.7;
  }

  .geojson-card {
    width: 190px;
    min-height: 170px;
    max-height: 220px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 12px;
    text-align: center;
    transition: transform 0.12s;
    overflow: hidden;
  }
  .geojson-card:hover { transform: translateY(-3px); }

  .geojson-card .file-icon { font-size: 1.6rem; color: var(--brand); }
  .geojson-card .filename {
    font-weight: 600;
    font-size: 0.85rem;
    color: #222;
    width: 100%;
    text-align: center;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
    line-height: 1.15;
    margin-top: 2px;
  }

  .geojson-card .controls {
    display:flex;
    gap:6px;
    justify-content: center;
    align-items:center;
    margin-top: auto;
  }

  .geojson-card .btn {
    font-size: 0.72rem;
    padding: 6px 8px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }
  .btn-download { background: #3aa65d; color: #fff; }
  .btn-download:hover { background: #2f8f4d; }
  .btn-view { background: var(--brand); color: #fff; }
  .btn-view:hover { background: var(--brand-dark); }

  #geojsonList { display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start; padding:8px 0; }
  #searchBox { border: 1px solid #d6dff6; }

  #spinnerOverlay { position:absolute; inset:0; background: rgba(255,255,255,0.85); display:flex; align-items:center; justify-content:center; border-radius:12px; z-index:20; display:none; }

  #mapContainer {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 760px;
    height: 580px;
    display: none;
    border: 2px solid var(--brand);
    border-radius: 10px;
    z-index: 9999;
    background: #fff;
    overflow: hidden;
    box-shadow: 0 8px 40px rgba(0,0,0,0.25);
  }
  #mapHeader {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    background: var(--brand);
    color: #fff;
    padding: 8px 12px;
    font-weight:600;
  }
  #mapHeader .map-title { font-size: 0.95rem; }
  #closeMapBtn { background:transparent; border:none; color:#fff; font-size:1.15rem; cursor:pointer; }
  #map { width:100%; height: calc(100% - 44px); }

  @media (max-width: 900px) {
    #mapContainer { width: calc(100% - 40px); left:20px; right:20px; height: 60vh; }
    .geojson-card { width: 46%; }
  }
</style>
</head>
<body>
<nav class="navbar navbar-dark mb-4 shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand d-flex align-items-center"><i class="bi bi-map"></i> Zoning Scraper Dashboard</span>
  </div>
</nav>

<div class="container">
  <div class="row mb-4 g-3">
    <div class="col-lg-6">
      <div class="card p-3" id="jobCard">
        <div id="spinnerOverlay"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>

        <div class="card-header mb-3"><i class="bi bi-play-circle-fill me-2"></i> Start New Job</div>

        <form id="scrapeForm" class="d-flex flex-column h-100">
          <div class="mb-2">
            <label class="form-label">Base URL</label>
            <input id="baseUrlInput" name="base_url" class="form-control" placeholder="https://jacksonin.wthgis.com/" required>
          </div>

          <button type="button" id="fetchLayersBtn" class="btn btn-orange mb-3"><i class="bi bi-search me-1"></i> Fetch Layers</button>

          <div class="mb-2">
            <label class="form-label">Layer</label>
            <select id="layerSelect" name="selected_layer" class="form-select" required disabled><option value="">Select a layer</option></select>
          </div>

          <div class="row mb-2">
            <div class="col">
              <label class="form-label">Start F</label>
              <input name="start_f" type="number" class="form-control" value="0" required>
            </div>
            <div class="col">
              <label class="form-label">D Value</label>
              <input name="D_value" type="text" class="form-control" readonly>
            </div>
            <div class="col">
              <label class="form-label">Max F</label>
              <input name="max_f" type="number" class="form-control" required>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Table Name</label>
            <input name="table_name" class="form-control" required>
          </div>

          <div class="mt-auto">
            <button type="submit" class="btn btn-orange w-100"><i class="bi bi-rocket-takeoff-fill me-1"></i> Start Job</button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3 h-100">
        <div class="card-header mb-3"><i class="bi bi-cpu me-2"></i> Active Jobs</div>
        <div id="jobList" class="list-group p-2 d-flex align-items-center justify-content-center">
          <div class="empty-state"><i class="bi bi-hourglass-split"></i>No active jobs</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card p-3">
        <div class="card-header mb-3"><i class="bi bi-bar-chart-line me-2"></i> Job Progress</div>
        <div id="progressContent"><div class="empty-state"><i class="bi bi-speedometer2"></i>No active job right now</div></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card p-3">
        <div class="card-header mb-3"><i class="bi bi-folder2-open me-2"></i> GeoJSON Files</div>
        <input id="searchBox" class="form-control mb-3" placeholder="Search files..." />
        <div id="geojsonList" class="d-flex flex-wrap"></div>
      </div>
    </div>
  </div>
</div>

<div id="mapContainer" aria-hidden="true">
  <div id="mapHeader">
    <div class="map-title">üó∫Ô∏è GeoJSON Viewer</div>
    <div>
      <button id="closeMapBtn" title="Close">‚úñ</button>
    </div>
  </div>
  <div id="map"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let selectedJobId = null;
let ws = null;
const spinnerOverlay = document.getElementById("spinnerOverlay");
const layerSelect = document.getElementById("layerSelect");
let mapInstance = null;
let geojsonLayer = null;

// Fetch layers
document.getElementById("fetchLayersBtn").onclick = async () => {
  const url = document.getElementById("baseUrlInput").value.trim();
  if(!url) return alert("Enter a Base URL first");

  spinnerOverlay.style.display = "flex";
  layerSelect.disabled = true;
  layerSelect.innerHTML = '<option>Loading layers...</option>';

  try {
    const res = await fetch("/extract_layers", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ base_url: url })
    });
    const data = await res.json();
    layerSelect.innerHTML = '<option value="">Select a layer</option>';
    if(data.error){ alert(data.error); spinnerOverlay.style.display="none"; return; }

    data.layers.forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.link;
      opt.textContent = l.name;
      opt.dataset.table_name = l.table_name || "";
      opt.dataset.max_f = l.F || "";
      opt.dataset.D = l.D || "";
      layerSelect.appendChild(opt);
    });
  } catch(err){
    console.error(err);
    alert("Error fetching layers");
  } finally {
    spinnerOverlay.style.display = "none";
    layerSelect.disabled = false;
  }
};

// Update Table Name, Max F, D
layerSelect.onchange = (e) => {
  const selected = e.target.selectedOptions[0];
  if(!selected) return;
  document.querySelector("input[name='table_name']").value = selected.dataset.table_name || "";
  const maxFInput = document.querySelector("input[name='max_f']");
  const fValue = parseInt(selected.dataset.max_f);
  if(!isNaN(fValue)) maxFInput.value = fValue;
  document.querySelector("input[name='D_value']").value = selected.dataset.D || "";
};

// Start new job
document.getElementById("scrapeForm").onsubmit = async (e)=>{
  e.preventDefault();
  const formData = new FormData(e.target);
  if(!formData.get("selected_layer")) return alert("Select a layer");
  await fetch("/start_job", {method:"POST", body:formData});
  fetchJobs();
};

// Fetch active jobs
async function fetchJobs() {
  const res = await fetch("/jobs");
  const data = await res.json();
  const jobs = data.running_jobs;
  const jobListEl = document.getElementById("jobList");
  jobListEl.innerHTML = "";
  if(Object.keys(jobs).length===0){
    jobListEl.innerHTML='<div class="empty-state"><i class="bi bi-hourglass-split"></i>No active jobs</div>';
    document.getElementById("progressContent").innerHTML='<div class="empty-state"><i class="bi bi-speedometer2"></i>No active job right now</div>';
    return;
  }
  for(const id in jobs){
    const job = jobs[id];
    const card = document.createElement("div");
    card.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
    card.innerHTML = `<span>${job.table_name}</span> <small>${job.start_f}-${job.max_f}</small>`;
    card.onclick = ()=>selectJob(id, job.table_name);
    jobListEl.appendChild(card);
  }
}

// Select job
function selectJob(jobId, tableName){
  selectedJobId = jobId;
  document.getElementById("progressContent").innerHTML = `
    <div class="d-flex justify-content-between mb-2">
      <span id="jobName" class="fw-bold">${tableName}</span>
      <button id="stopBtn" class="btn btn-danger btn-sm"><i class="bi bi-stop-fill"></i> Stop</button>
    </div>
    <div class="progress mb-2">
      <div id="progressBar" class="progress-bar bg-success" style="width:0%"></div>
    </div>
    <div id="progressText" class="small text-muted mb-2"></div>
    <pre id="logs"></pre>
    <a id="downloadLink" class="btn btn-success w-100 d-none mt-2" target="_blank"><i class="bi bi-download me-1"></i>Download GeoJSON</a>
  `;
  if(ws) ws.close();
  ws = new WebSocket(`ws://${location.host}/ws/${jobId}`);
  ws.onmessage = (event)=>{
    const d = JSON.parse(event.data);
    document.getElementById("logs").innerText = d.logs.join("\n");
    const total = d.completed+d.failed;
    const percent = total>0?((d.completed/total)*100).toFixed(1):0;
    document.getElementById("progressBar").style.width = percent+"%";
    document.getElementById("progressText").innerText=`‚úÖ Completed: ${d.completed} | ‚ùå Failed: ${d.failed}`;
    if(d.done){
      document.getElementById("stopBtn").disabled=true;
      document.getElementById("downloadLink").href=`/download/${tableName}.geojson`;
      document.getElementById("downloadLink").classList.remove("d-none");
      fetchGeojsonList();
    }
  };
  document.getElementById("stopBtn").onclick = async ()=>{ await fetch(`/stop_job/${jobId}`, {method:"POST"}); };
}

// View GeoJSON
function viewGeoJSON(fileUrl) {
  const mapContainer = document.getElementById("mapContainer");
  mapContainer.style.display = "block";

  if (!mapInstance) {
    mapInstance = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapInstance);
  }

  if (geojsonLayer) {
    mapInstance.removeLayer(geojsonLayer);
  }

  fetch(fileUrl)
    .then(r => r.json())
    .then(data => {
      geojsonLayer = L.geoJSON(data, {
        onEachFeature: function (feature, layer) {
          let props = feature.properties;
          let popup = "<b>Attributes:</b><br>";
          for (let key in props) popup += `${key}: ${props[key]}<br>`;
          layer.bindPopup(popup);
        }
      }).addTo(mapInstance);
      mapInstance.fitBounds(geojsonLayer.getBounds());
    })
    .catch(err => alert("Failed to load GeoJSON: " + err));
}

// Close map viewer
document.getElementById("closeMapBtn").addEventListener("click", () => {
  document.getElementById("mapContainer").style.display = "none";
});

// Fetch geojson files
async function fetchGeojsonList() {
  const res = await fetch("/geojson_list");
  const data = await res.json();
  const files = data.files.sort((a,b)=>b.localeCompare(a));
  const filter = document.getElementById("searchBox").value.toLowerCase();
  const geojsonListEl = document.getElementById("geojsonList");
  geojsonListEl.innerHTML = "";

  let displayFiles;
  if(filter) displayFiles = files.filter(f=>f.toLowerCase().includes(filter));
  else displayFiles = files.slice(0,6);

  if(displayFiles.length===0){
    geojsonListEl.innerHTML='<div class="empty-state"><i class="bi bi-file-earmark-text"></i>No matching files</div>';
    return;
  }

  displayFiles.forEach(f=>{
    const card = document.createElement("div");
    card.className="geojson-card";
    card.innerHTML=`
      <i class="bi bi-file-earmark-text-fill"></i>
      <span title="${f}">${f}</span>
      <div>
        <a href="/download/${f}" class="btn btn-success btn-sm me-1">
          <i class="bi bi-download"></i> Download
        </a>
        <button class="btn btn-primary btn-sm" onclick="viewGeoJSON('/download/${f}')">
          <i class="bi bi-eye"></i> View
        </button>
      </div>
    `;
    geojsonListEl.appendChild(card);
  });
}

document.getElementById("searchBox").oninput = fetchGeojsonList;

// Initial fetch
fetchJobs();
fetchGeojsonList();
setInterval(fetchJobs,4000);
setInterval(fetchGeojsonList,5000);
</script>
</body>
</html>
